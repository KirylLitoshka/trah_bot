import pathlib
import json
import os
from aiogram import Dispatcher, Bot, executor, types

STORAGE_DIR = os.path.join(pathlib.Path(__file__).parent, "storage")


async def on_startup(dp: Dispatcher):
    with open(f"{STORAGE_DIR}/users.json", mode="r", encoding="utf8") as user_storage:
        users_data = json.loads(user_storage.read())
        dp.data['users'] = users_data

    await dp.bot.set_my_commands(
        [
            types.BotCommand("start", "üíü –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞")
        ]
    )
    dp.register_message_handler(gender_selection, commands=["start"])
    dp.register_message_handler(picture_type_selection, lambda msg: msg.text in menu["gender"].values())
    dp.register_message_handler(novel_selection, lambda msg: msg.text in menu["picture_type"].values())


async def on_shutdown(dp: Dispatcher):
    dp.stop_polling()
    await dp.wait_closed()


menu = {
    "gender": {
        "male": "üíÅ‚Äç‚ôÇÔ∏è –ü–∞—Ä–Ω–∏",
        "female": "üíÅ‚Äç‚ôÄÔ∏è –î–µ–≤—É—à–∫–∏"
    },
    "picture_type": {
        "real": "üíã –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ 2D –∞—Ä—Ç—ã",
        "photo": "üì∏ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏",
        "anime": "üç≠ –ê–Ω–∏–º–µ 2D –∞—Ä—Ç—ã"
    },
    "novels": {
        "female": {
            "real": "https://t.me/TestCucumber2Bot",
            "photo": "https://t.me/TestCucumber2Bot",
            "anime": "https://t.me/TestCucumber2Bot"
        },
        "male": {
            "real": "https://t.me/TestCucumberBot",
            "photo": "https://t.me/TestCucumberBot",
            "anime": "https://t.me/TestCucumberBot"
        }
    }
}


async def create_new_user(user_id, users_storage):
    users_storage[str(user_id)] = {
        "gender": None,
        "picture_type": None,
        "current_choices": "gender"
    }


async def gender_selection(message: types.Message):
    users = Dispatcher.get_current().data["users"]
    if message.from_user.id not in users:
        await create_new_user(message.from_user.id, users)
    await message.answer(
        text="–° –∫–µ–º —Ç—ã —Ö–æ—á–µ—à—å –Ω–∞—á–∞—Ç—å —Å–≤–æ–π –¥–∏–∞–ª–æ–≥?",
        reply_markup=types.ReplyKeyboardMarkup(
            keyboard=[
                [types.KeyboardButton("üíÅ‚Äç‚ôÇÔ∏è –ü–∞—Ä–Ω–∏")],
                [types.KeyboardButton("üíÅ‚Äç‚ôÄÔ∏è –î–µ–≤—É—à–∫–∏")],
            ],
            resize_keyboard=True,
            one_time_keyboard=True
        )
    )


async def picture_type_selection(message: types.Message):
    users = Dispatcher.get_current().data["users"]
    user_id = str(message.from_user.id)
    if message.text not in menu[users[user_id]["current_choices"]].values():
        await Bot.get_current().delete_message(message.chat.id, message.message_id)
    users[user_id]["gender"] = next((key for key, val in menu["gender"].items() if val == message.text), None)
    users[user_id]["current_choices"] = "picture_type"
    await message.answer(
        text="–í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–∑—É–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ –∏—Å—Ç–æ—Ä–∏–∏.\n\n"
             "<i>–í –Ω–∞—à–∏—Ö –∏—Å—Ç–æ—Ä–∏—è—Ö –í—ã –º–æ–∂–µ—Ç–µ —É–≤–∏–¥–µ—Ç—å –∞—Ä—Ç—ã –∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —Å –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º —Å–µ–∫—Å—É–∞–ª—å–Ω–æ–≥–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞ üîû</i>",
        parse_mode="HTML",
        reply_markup=types.ReplyKeyboardMarkup(
            keyboard=[
                [types.KeyboardButton("üíã –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ 2D –∞—Ä—Ç—ã")],
                [types.KeyboardButton("üì∏ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏")],
                [types.KeyboardButton("üç≠ –ê–Ω–∏–º–µ 2D –∞—Ä—Ç—ã")],
            ],
            resize_keyboard=True,
            one_time_keyboard=True
        )
    )


async def novel_selection(message: types.Message):
    users = Dispatcher.get_current().data["users"]
    user_id = str(message.from_user.id)
    current_user = users[user_id]
    if message.text not in menu[users[user_id]["current_choices"]].values():
        await Bot.get_current().delete_message(message.chat.id, message.message_id)
    current_user["picture_type"] = next((key for key, val in menu["picture_type"].items() if val == message.text), None)
    current_user["current_choices"] = "novels"
    novel_link = menu["novels"][current_user["gender"]][current_user["picture_type"]]
    await message.answer(
        text="–¢–≤–æ–π —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫ —É–∂–µ –∂–¥–µ—Ç —Ç–µ–±—è –≤ —á–∞—Ç–µ.\n–ü–µ—Ä–µ—Ö–æ–¥–∏ –ø–æ —Å—Å—ã–ª–∫–µ",
        reply_markup=types.InlineKeyboardMarkup().add(types.InlineKeyboardButton("–ù–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ", url=novel_link))
    )


async def restart(message: types.Message):
    users = Dispatcher.get_current().data["users"]
    try:
        del users[str(message.from_user.id)]
        await gender_selection(message)
    except KeyError:
        await gender_selection(message)


def main():
    bot = Bot("5767674258:AAHmpIMRYeEFupfYt9M553DoP2GTXgLRJh8")
    dispatcher = Dispatcher(bot)
    executor.start_polling(
        dispatcher=dispatcher,
        on_startup=on_startup,
        on_shutdown=on_shutdown,
        skip_updates=True
    )


if __name__ == "__main__":
    main()
